// worldcore/test/vulnerability.test.ts
//
// Tests for the generic Vulnerability debuff that increases incoming damage
// via damageTakenPct.

import test from "node:test";
import assert from "node:assert/strict";

import {
  applyVulnerability,
  DEFAULT_VULNERABILITY_CONFIG,
} from "../combat/Vulnerability";

import { computeCombatStatusSnapshot } from "../combat/StatusEffects";

import {
  type CharacterState,
  defaultAttributes,
  defaultInventory,
  defaultEquipment,
  defaultSpellbook,
  defaultAbilities,
  defaultProgression,
} from "../characters/CharacterTypes";

function makeChar(): CharacterState {
  const now = new Date();
  const progression = defaultProgression() as any;
  if (!progression.flags) progression.flags = {};

  return {
    id: "char-vuln-test",
    userId: "user-vuln-test",
    shardId: "prime_shard",
    name: "VulnerabilityTester",
    classId: "warrior",
    level: 1,
    xp: 0,
    posX: 0,
    posY: 0,
    posZ: 0,
    lastRegionId: "prime_shard:0,0",
    appearanceTag: null,
    attributes: defaultAttributes(),
    inventory: defaultInventory(),
    equipment: defaultEquipment(),
    spellbook: defaultSpellbook(),
    abilities: defaultAbilities(),
    progression,
    stateVersion: 1,
    createdAt: now,
    updatedAt: now,
    guildId: null,
  };
}

test("Vulnerability: single application increases damageTakenPct", () => {
  const now = 0;
  const char = makeChar();

  const statusBefore = computeCombatStatusSnapshot(char, now);
  const beforeTakenPct = statusBefore.damageTakenPct ?? 0;

  assert.equal(
    beforeTakenPct,
    0,
    "Baseline damageTakenPct should be 0 with no effects",
  );

  applyVulnerability(char, 1, now);

  const statusAfter = computeCombatStatusSnapshot(char, now);
  const afterTakenPct = statusAfter.damageTakenPct ?? 0;

  assert.ok(
    afterTakenPct > beforeTakenPct,
    `Expected vulnerability to increase damageTakenPct, got before=${beforeTakenPct}, after=${afterTakenPct}`,
  );

  // Default config is +10% per stack.
  assert.ok(
    afterTakenPct > 0.09 && afterTakenPct < 0.11,
    `Expected ~0.10 damageTakenPct for 1 stack, got ${afterTakenPct}`,
  );
});

test("Vulnerability: higher stacks increase damageTakenPct further (up to maxStacks)", () => {
  const now = 0;
  const char1 = makeChar();
  const char2 = makeChar();

  // 1 stack on char1
  applyVulnerability(char1, 1, now);
  const status1 = computeCombatStatusSnapshot(char1, now);
  const pct1 = status1.damageTakenPct ?? 0;

  // 3 stacks on char2 (or capped at maxStacks)
  applyVulnerability(char2, 3, now);
  const status2 = computeCombatStatusSnapshot(char2, now);
  const pct3 = status2.damageTakenPct ?? 0;

  assert.ok(
    pct1 > 0,
    `Expected non-zero damageTakenPct for 1 vulnerability stack, got ${pct1}`,
  );
  assert.ok(
    pct3 > pct1,
    `Expected more damageTakenPct for 3 stacks vs 1, got 1-stack=${pct1}, 3-stack=${pct3}`,
  );

  const perStack = DEFAULT_VULNERABILITY_CONFIG.perStackDamageTakenPct;
  const expected3 = perStack * 3;

  // Allow a tolerance since StatusEffects may apply per stack internally.
  assert.ok(
    pct3 > expected3 - 0.05 && pct3 < expected3 + 0.05,
    `Expected ~${expected3} damageTakenPct for 3 stacks, got ${pct3}`,
  );
});
