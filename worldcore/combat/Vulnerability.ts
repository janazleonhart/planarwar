// worldcore/combat/Vulnerability.ts
//
// Shared helpers for applying a generic "vulnerability" debuff that
// increases incoming damage via StatusEffects.
//
// Design v1:
// - Effect id: "vulnerability_exposed"
// - Name: "Exposed Weakness"
// - Source kind: "spell" (can be used by abilities/spells/NPCs later)
// - Tags: ["debuff", "vulnerability"]
// - Behavior: per-stack damageTakenPct increase, with a hard maxStacks cap.
//
// This module does NOT decide *when* to apply vulnerability; it only
// provides helpers that spells/abilities/AI/debug commands can call.

import type { CharacterState } from "../characters/CharacterTypes";
import { applyStatusEffect } from "./StatusEffects";

export const VULNERABILITY_EFFECT_ID = "vulnerability_exposed";

export interface VulnerabilityConfig {
  /** Internal effect id (must be stable to stack/refresh correctly). */
  id: string;
  /** Display name for the effect. */
  name: string;
  /** How much damageTakenPct to add per stack (e.g. 0.10 = +10%). */
  perStackDamageTakenPct: number;
  /** Maximum stacks allowed for this vulnerability effect. */
  maxStacks: number;
  /** Duration of the effect in milliseconds. */
  durationMs: number;
}

export const DEFAULT_VULNERABILITY_CONFIG: VulnerabilityConfig = {
  id: VULNERABILITY_EFFECT_ID,
  name: "Exposed Weakness",
  perStackDamageTakenPct: 0.1, // +10% damage taken per stack
  maxStacks: 3,
  durationMs: 12_000, // 12s baseline
};

/**
 * Apply a vulnerability effect to a character.
 *
 * - `stacks` is how many stacks to apply in this call (1..maxStacks).
 * - Total stacks are capped by config.maxStacks via StatusEffects logic.
 *
 * Usage examples:
 *   applyVulnerability(char, 1);        // +10% damage taken for 12s
 *   applyVulnerability(char, 2);        // +20% damage taken for 12s
 *
 * Callers can supply a custom config for stronger/weaker variants.
 */
export function applyVulnerability(
  target: CharacterState,
  stacks: number = 1,
  now: number = Date.now(),
  config: VulnerabilityConfig = DEFAULT_VULNERABILITY_CONFIG,
): void {
  const clampedStacks = Math.max(1, Math.min(stacks, config.maxStacks));

  applyStatusEffect(
    target,
    {
      id: config.id,
      sourceKind: "spell",
      sourceId: "vulnerability",
      name: config.name,
      durationMs: config.durationMs,
      maxStacks: config.maxStacks,
      initialStacks: clampedStacks,
      tags: ["debuff", "vulnerability"],
      modifiers: {
        damageTakenPct: config.perStackDamageTakenPct,
      },
    },
    now,
  );
}
