// worldcore/combat/Vulnerability.ts
//
// Shared helpers for applying a generic "vulnerability" debuff that
// increases incoming damage via StatusEffects.
//
// Design v1:
// - Effect id: "vulnerability_exposed"
// - Name: "Exposed Weakness"
// - Source kind: "spell" (can be used by abilities/spells/NPCs later)
// - Tags: ["debuff", "vulnerability"]
// - Behavior: per-stack damageTakenPct increase, with a hard maxStacks cap.
//
// Upgrade:
// - Optional `school` lets you make it per-school via damageTakenPctBySchool.

import type { CharacterState } from "../characters/CharacterTypes";
import type { DamageSchool } from "./CombatEngine";
import { applyStatusEffect } from "./StatusEffects";

export const VULNERABILITY_EFFECT_ID = "vulnerability_exposed";

export interface VulnerabilityConfig {
  /** Internal effect id (must be stable to stack/refresh correctly). */
  id: string;
  /** Display name for the effect. */
  name: string;
  /** How much to add per stack (e.g. 0.10 = +10%). */
  perStackDamageTakenPct: number;
  /** Maximum stacks allowed. */
  maxStacks: number;
  /** Duration in ms. */
  durationMs: number;
  /** Optional: apply only to a school (fire, frost, physical, etc.). */
  school?: DamageSchool;
}

export const DEFAULT_VULNERABILITY_CONFIG: VulnerabilityConfig = {
  id: VULNERABILITY_EFFECT_ID,
  name: "Exposed Weakness",
  perStackDamageTakenPct: 0.10,
  maxStacks: 5,
  durationMs: 20_000,
};

export function applyVulnerability(
  target: CharacterState,
  stacks: number = 1,
  now: number = Date.now(),
  config: VulnerabilityConfig = DEFAULT_VULNERABILITY_CONFIG,
): void {
  const clampedStacks = Math.max(1, Math.min(stacks, config.maxStacks));

  const modifiers: any = {};
  if (config.school) {
    modifiers.damageTakenPctBySchool = { [config.school]: config.perStackDamageTakenPct };
  } else {
    modifiers.damageTakenPct = config.perStackDamageTakenPct;
  }

  applyStatusEffect(
    target,
    {
      id: config.id,
      sourceKind: "spell",
      sourceId: "vulnerability",
      name: config.name,
      durationMs: config.durationMs,
      maxStacks: config.maxStacks,
      initialStacks: clampedStacks,
      tags: ["debuff", "vulnerability"],
      modifiers,
    },
    now,
  );
}
